import numpy as np
import pandas as pd
import sqlalchemy
from sqlalchemy import create_engine
from pathlib import Path
import smtplib, ssl


# define MySQL db credentials
user = [username]
password = [password]
engine = create_engine('mysql+mysqlconnector://[user]:[password][ip]/[db]')

start_date = '2017-01-01'
end_date = '2021-07-31'
last_month = '07'

# create new folder to store files
print("Creating new folder: 2021-" + last_month)
folder_path = r'C:\Users\oozew\Desktop\' + last_month
Path(folder_path).mkdir(parents=True, exist_ok=True)

# SQL code to run
query = """[SQL code]"""
print("Running code...")
df = pd.read_sql_query(query,engine)
df.to_csv(folder_path + '\\output.csv', index=False)
print("Extraction completed")

# send email with details
port = 465  # For SSL
smtp_server = "smtp.gmail.com"
sender_email = "[sender email]"
receiver_email = "[receiver email]"
password = "[email password]"
message = """\
Subject: Codes complete
This is an automated message. Please do not reply.

Hello,
Codes have finished running.
Have a nice day!"""

context = ssl.create_default_context()
with smtplib.SMTP_SSL(smtp_server, port, context=context) as server:
    server.login(sender_email, password)
    server.sendmail(sender_email, receiver_email, message)
print ('Email dispatched')
